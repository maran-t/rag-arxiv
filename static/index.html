<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RAG ‚Äî Single Page (with loader)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --heading-color: #0f172a;         /* slate-900 */
      --heading-line-height: 1.2;
      --heading-weight: 600;
      --h1-size: 2rem;
      --h2-size: 1.5rem;
      --h3-size: 1.125rem;
      --h4-size: 1rem;
      --h5-size: 0.9375rem;
      --h6-size: 0.875rem;
    }

    .no-tailwind h1,
    .no-tailwind h2,
    .no-tailwind h3,
    .no-tailwind h4,
    .no-tailwind h5,
    .no-tailwind h6 {
      margin: 0 0 0.6rem 0;
    }

    .no-tailwind h1, .no-tailwind h2, .no-tailwind h3, .no-tailwind h4, .no-tailwind h5, .no-tailwind h6 {
      margin-top: 1.25rem;    /* space above */
      margin-bottom: 0.75rem; /* space below */
    }

    .no-tailwind ul, .no-tailwind ol {
      padding-left: 1rem;
      margin-bottom: 0.75rem;
    }

      .no-tailwind, .no-tailwind * {
        all: revert;   /* revert to browser defaults */
      }

    /* Accessibility: larger sizes for small screens if needed */
    /* @media (max-width: 480px) {
      .no-tailwind h1 { font-size: calc(var(--h1-size) * 0.9); }
      .no-tailwind h2 { font-size: calc(var(--h2-size) * 0.95); }
    } */

  </style>
</head>
<body class="bg-white min-h-screen">
  <!-- Top nav -->
  <header class="bg-white">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <!-- Company logo + product -->
        <div class="flex items-center gap-3">
          <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='40' height='40' rx='8' fill='%230256d6'/><text x='20' y='26' font-size='18' font-family='Arial' fill='white' text-anchor='middle' font-weight='700'>R</text></svg>" alt="logo" class="w-10 h-10 rounded" />
          <div>
            <div class="text-base font-semibold text-gray-800">RAG Document Assistant</div>
            <div class="text-xs text-gray-500">Enterprise Knowledge ‚Äî Secure, Fast</div>
          </div>
        </div>
      </div>

      <!-- Center: search (kept in header for wider layout consistency) -->
      <div class="flex-1 flex justify-center">
        <div class="w-full max-w-sm flex items-center bg-gray-50 rounded-lg px-3 py-1 border">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
          <input id="globalSearch" placeholder="Search across org docs..." class="flex-1 bg-transparent text-sm focus:outline-none" />
        </div>
      </div>

      <!-- Right: user -->
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-xs text-gray-700">MT</div>
        <div class="hidden sm:block text-sm text-gray-700">Manimaran T</div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left column: Collections + Upload -->
    <aside class="lg:col-span-1 bg-white p-4">
      <h4 class="text-sm font-semibold text-gray-700 mb-3">Collections</h4>
      <div class="flex flex-col gap-2">
        <button class="text-left px-3 py-2 rounded-lg hover:bg-gray-50 transition bg-gray-50" data-filter="all">All Documents</button>
        <button class="text-left px-3 py-2 rounded-lg hover:bg-gray-50 transition" data-filter="pdf">PDF</button>
        <button class="text-left px-3 py-2 rounded-lg hover:bg-gray-50 transition" data-filter="docx">DOCX</button>
        <button class="text-left px-3 py-2 rounded-lg hover:bg-gray-50 transition" data-filter="manuals">Manuals</button>
      </div>

      <div class="mt-6">
        <h5 class="text-xs text-gray-500 uppercase mb-2">Upload files</h5>
        <label id="dropzone" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition text-center p-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M4 12l6-6m0 0l6 6m-6-6v12" />
          </svg>
          <div class="text-sm text-gray-600 mt-2">Drag & drop or click to add files</div>
          <input id="fileInput" type="file" multiple class="hidden" />
        </label>
        <div id="fileList" class="mt-3 text-sm text-gray-700 space-y-2"></div>

        <button id="processBtn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700">Process to Vector DB</button>
        <!-- <button id="rebuildBtn" class="mt-2 w-full rounded-xl py-2 bg-gray-100">Rebuild DB</button> -->

        <!-- üîΩ New notice message -->
        <div class="mt-12 text-xs text-gray-500 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
          ‚ö†Ô∏è The above section is <strong>in development</strong>.  
          Currently, you can chat with the existing RAG dataset:  
          <span class="font-medium text-gray-700">arxiv-paper-abstracts</span>.
        </div>
      </div>
    </aside>

<!-- Right: Chat panel (replace your existing section with this) -->
<section class="lg:col-span-2 bg-white rounded-2xl p-6 flex flex-col h-[calc(100vh-150px)] relative">
  <!-- Note: this outer wrapper is 'relative' so overlay can be positioned over the visible area -->
  <!-- Conversation (messages container). extra bottom padding so sticky input doesn't overlap -->
  <div id="conversation" class="no-tailwind flex-1 overflow-auto pb-28 relative">
    <!-- inner messages container (we append messages here) -->
    <div id="messages" class="flex flex-col gap-4" style="padding: 16px;"></div>
  </div>

  <!-- Default overlay moved OUTSIDE the scrollable conversation so it stays fixed over the visible viewport -->
  <div id="defaultOverlay" 
       class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 text-lg bg-white/80 backdrop-blur-sm transition-opacity pointer-events-none">
    <div id="overlayMessage" class="mb-3">Start searching your documents‚Ä¶</div>
    <div id="overlaySpinner" class="hidden flex items-center gap-2 text-sm text-gray-600">
      <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
      Processing‚Ä¶
    </div>
  </div>

  <!-- Chat input anchored to bottom of the panel -->
  <div id="chatInput" class="sticky bottom-0 bg-white pt-3">
    <div class="flex gap-3 items-center">
      <input id="queryBox" type="text" placeholder="Ask anything..." 
             class="flex-1 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-400 border" />
      <button id="askNow" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Ask</button>
    </div>
      <div class="p-4 pb-0 rounded-lg text-sm">
      <strong>Welcome:</strong> This is a prototype UI for a Retrieval-Augmented Generation (RAG) system.
    </div>
  </div>
</section>
  </main>

  <!-- <footer class="max-w-7xl mx-auto px-6 py-6 text-xs text-gray-500">Prototype ‚Äî UI only. Connect to your backend for actual parsing, embeddings, and retrieval.</footer> -->

  <script>
    // Elements
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const fileList = document.getElementById('fileList');
    const processBtn = document.getElementById('processBtn');
    // const rebuildBtn = document.getElementById('rebuildBtn');
    const askNow = document.getElementById('askNow');
    const queryBox = document.getElementById('queryBox');
    const conversation = document.getElementById('conversation');
    const messages = document.getElementById('messages');
    const defaultOverlay = document.getElementById('defaultOverlay');
    const overlayMessage = document.getElementById('overlayMessage');
    const overlaySpinner = document.getElementById('overlaySpinner');

    let uploadedFiles = [];
    let processing = false; // for file processing simulation
    let loadingAnswer = false; // for query loading state

    function renderFiles() {
      if (uploadedFiles.length === 0) {
        fileList.innerHTML = '<div class="text-xs text-gray-400">No files uploaded</div>';
        return;
      }
      fileList.innerHTML = uploadedFiles.map(f => `
        <div class="flex justify-between items-center rounded-lg px-3 py-2 bg-gray-50">
          <div class="truncate text-sm">${escapeHtml(f.name)}</div>
          <div class="text-xs text-gray-400">${Math.round(f.size/1024)} KB</div>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      const rawHtml = marked.parse(String(text));
      return DOMPurify.sanitize(rawHtml);
    }

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-blue-400'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-blue-400'));
    dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('border-blue-400'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    function handleFiles(list) {
      for (let i=0;i<list.length;i++) uploadedFiles.push(list[i]);
      renderFiles();
      updateOverlayVisibility();
    }

    // Update overlay visibility based on whether there are messages and loading state
    function updateOverlayVisibility() {
      // If loading an answer, show overlay with spinner
      if (loadingAnswer) {
        defaultOverlay.style.opacity = '1';
        defaultOverlay.style.pointerEvents = 'auto';
        overlaySpinner.classList.remove('hidden');
        overlayMessage.textContent = 'Thinking‚Ä¶';
        return;
      }

      // Determine if there are meaningful messages
      const nonOverlayChildren = Array.from(messages.children || []);
      const hasMeaningfulMessages = nonOverlayChildren.some(el => (el.textContent || '').trim().length > 40);

      if (nonOverlayChildren.length === 0 || !hasMeaningfulMessages) {
        defaultOverlay.style.opacity = '1';
        defaultOverlay.style.pointerEvents = 'auto';
        overlaySpinner.classList.add('hidden');
        overlayMessage.textContent = 'Start searching your documents‚Ä¶';
      } else {
        defaultOverlay.style.opacity = '0';
        defaultOverlay.style.pointerEvents = 'none';
      }
    }

    // Helper to append a message to messages container and then scroll to bottom
    function appendMessageHtml(html) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      messages.appendChild(wrapper);
      // Auto-scroll to bottom
      conversation.scrollTop = conversation.scrollHeight;
      updateOverlayVisibility();
    }

    // Show a small inline loader (used while waiting for answer)
    function showInlineLoading() {
      loadingAnswer = true;
      updateOverlayVisibility();
    }
    function hideInlineLoading() {
      loadingAnswer = false;
      updateOverlayVisibility();
    }

    // Ask button handler: show loader, call backend, display answer in conversation
askNow.addEventListener('click', async () => {
  const q = queryBox.value.trim(); 
  if (!q) return;

  // Show overlay loader while waiting
  showInlineLoading();

  // Show the user's query as a small bubble (right aligned)
  appendMessageHtml(`
    <div class="text-right">
      <div class="inline-block bg-blue-600 text-white px-4 rounded-lg">
        ${escapeHtml(q)}
      </div>
    </div>
  `);

  try {
    // üîΩ Real backend call
    const resp = await fetch('/api/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: q })
    });

    if (!resp.ok) throw new Error(`Request failed: ${resp.status}`);

    const payload = await resp.json();
    const answer = payload?.data?.answer || "‚ö†Ô∏è No answer returned";
    const sources = payload?.data?.sources?.[0] ? [payload?.data?.sources?.[0]] : [];

    // Render answer from backend
    const sourcesHtml = sources.map(
      s => `<li>${escapeHtml(String(s.source || 'unknown'))}</li>`
    ).join('');

    const answerHtml = `
      <div class="p-4 bg-gray-50 rounded-lg text-sm text-gray-700">
        <div class="mt-2">${escapeHtml(answer)}</div>
        ${sources.length > 0 ? `
          <details class="mt-2">
            <summary class="text-xs text-gray-500">Sources (${sources.length})</summary>
            <ul class="text-xs text-gray-600 mt-2">${sourcesHtml}</ul>
          </details>` : ''}
      </div>
    `;

    appendMessageHtml(answerHtml);

  } catch (err) {
    // Error bubble
    const errHtml = `
      <div class="p-3 bg-red-50 text-red-700 rounded-lg text-sm">
        Request failed: ${escapeHtml(err.message || String(err))}
      </div>`;
    appendMessageHtml(errHtml);
  } finally {
    hideInlineLoading();
    queryBox.value = '';
  }
});
    // Support pressing Enter to send
    queryBox.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        askNow.click();
      }
    });

    // Simulated processing buttons (unchanged behavior but append messages)
    processBtn.addEventListener('click', () => {
      if (uploadedFiles.length === 0) { alert('Please upload files first.'); return; }
      if (processing) return;
      processing = true;

      // Simulate a progress bar interaction by showing overlay message briefly
      overlayMessage.textContent = 'Indexing documents‚Ä¶';
      overlaySpinner.classList.remove('hidden');
      defaultOverlay.style.opacity = '1';
      defaultOverlay.style.pointerEvents = 'auto';

      let pct = 0;
      const t = setInterval(() => {
        pct += Math.random()*20;
        if (pct >= 100) pct = 100;
        if (pct === 100) {
          clearInterval(t);
          processing = false;
          // Add confirmation message at bottom
          const okHtml = '<div class="p-4 bg-green-50 rounded-lg text-sm text-gray-700"><strong>Done:</strong> Documents processed and indexed (demo). You can now query.</div>';
          appendMessageHtml(okHtml);
          updateOverlayVisibility();
        }
      }, 400);
    });

    // rebuildBtn.addEventListener('click', () => {
    //   if (uploadedFiles.length === 0) { alert('No files to rebuild.'); return; }
    //   setTimeout(() => {
    //     const msgHtml = '<div class="p-3 bg-gray-50 rounded-lg text-sm text-gray-700">Vector DB rebuilt (simulated).</div>';
    //     appendMessageHtml(msgHtml);
    //     updateOverlayVisibility();
    //   }, 900);
    // });

    // Add an initial welcome message into messages (so overlay logic will treat it correctly)
    // appendMessageHtml('<div class="p-4 bg-gray-50 rounded-lg text-sm text-gray-700"><strong>Welcome:</strong> This is a prototype UI for a Retrieval-Augmented Generation (RAG) system.</div>');

    renderFiles();
    updateOverlayVisibility();
    // ensure conversation is scrolled to bottom on load
    conversation.scrollTop = conversation.scrollHeight;
  </script>
</body>
</html>
